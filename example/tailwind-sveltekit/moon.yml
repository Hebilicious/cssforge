$schema: "https://moonrepo.dev/schemas/project.json"

language: "typescript"
layer: "application"

dependsOn:
  - "cssforge"

tasks:
  prepare:
    script: "svelte-kit sync || echo ''"
  build:
    command: "vite"
    args: ["build"]
    deps:
      - "^:build"
      - "~:prepare"
  dev:
    command: "vite"
    args: ["dev"]
    deps:
      - "^:build"
      - "~:prepare"
    preset: "server"
    options:
      runInCI: false
  dev-e2e:
    command: "vite"
    args: ["dev", "--host", "127.0.0.1", "--port", "4176"]
    deps:
      - "^:build"
      - "~:prepare"
    preset: "server"
    options:
      runInCI: false
  preview:
    command: "vite"
    args: ["preview"]
    deps:
      - "~:build"
      - "~:prepare"
    preset: "server"
    options:
      runInCI: false
  check:
    script: "svelte-kit sync && svelte-check --tsconfig ./tsconfig.json"
    deps:
      - "~:prepare"
    options:
      runInCI: false
  check-watch:
    script: "svelte-kit sync && svelte-check --tsconfig ./tsconfig.json --watch"
    deps:
      - "~:prepare"
    options:
      runInCI: false
      persistent: true
      cache: false
      outputStyle: "stream"
  cssforge-generate:
    command: "tsx"
    args:
      - "../../packages/cssforge/src/cli.ts"
      - "--prefix"
      - "."
      - "--config"
      - "./cssforge.config.ts"
      - "--mode"
      - "css"
      - "--css"
      - "./.cssforge/output.css"
    deps:
      - "^:build"
    options:
      runInCI: false
  e2e:
    command: "playwright"
    args: ["test"]
    deps:
      - "~:cssforge-generate"
      - "~:prepare"
    options:
      runInCI: false
  e2e-headed:
    command: "playwright"
    args: ["test", "--headed"]
    deps:
      - "~:cssforge-generate"
      - "~:prepare"
    options:
      runInCI: false
  cssforge-build-local:
    command: "moon"
    args: ["run", "cssforge:jsr-dry-run"]
    options:
      runInCI: false
